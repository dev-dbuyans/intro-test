<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>í¼ë¸”ë¦¬ì‹± íŒŒì¼ë¦¬ìŠ¤íŠ¸</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/handsontable@14.0.0/dist/handsontable.full.min.css"
    />
    <style>
      body {
        font-family: 'Segoe UI', sans-serif;
        padding: 0px 40px 40px 40px;
        background-color: #f9f9f9;
        color: #333;
      }

      h2 {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .download-btn {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 8px 16px;
        font-size: 14px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        text-decoration: none; /* ë°‘ì¤„ ì œê±° */
      }

      .download-btn:hover {
        background-color: #45a049;
      }

      button.action-btn {
        padding: 4px 10px;
        font-size: 13px;
        background-color: #2196f3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      #hot {
        margin-top: 20px;
      }

      .hot-container {
        background: white;
        overflow: hidden;
      }

      .htCore td {
        padding: 8px 12px;
        vertical-align: middle;
      }

      .htCore th {
        padding: 10px 12px;
        background-color: #f2f2f2;
      }

      .button-group {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .grid-btn {
        background-color: #2196f3;
        color: white;
        border: none;
        padding: 8px 16px;
        font-size: 14px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      .grid-btn:hover {
        background-color: #1976d2;
      }

      .grid-btn.save {
        background-color: #4caf50;
      }

      .grid-btn.save:hover {
        background-color: #388e3c;
      }
    </style>
  </head>
  <body>
    <h2>
      í¼ë¸”ë¦¬ì‹± íŒŒì¼ë¦¬ìŠ¤íŠ¸
      <a href="./HTML_release.zip" class="download-btn" download>ğŸ“¥ HTML_release.zip</a>
    </h2>

    <div
      style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      "
    >
      <div>
        <button class="grid-btn" onclick="addCol()">â• ì—´ ì¶”ê°€</button>
      </div>
      <div>
        <button class="grid-btn save" onclick="saveData()">ğŸ’¾ ì €ì¥</button>
      </div>
    </div>

    <div id="hot" class="hot-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/handsontable@14.0.0/dist/handsontable.full.min.js"></script>
    <script>
      function getProjectNameFromPath() {
        const pathSegments = window.location.pathname.split('/').filter(Boolean)
        return pathSegments[0] || 'default' // ì˜ˆ: 'my_project'
      }

      // ì˜ˆ: projectNameì€ ê³ ì • ë¬¸ìì—´ì´ê±°ë‚˜ ë™ì ìœ¼ë¡œ ë°›ì•„ì˜¬ ìˆ˜ ìˆìŒ
      const projectName = getProjectNameFromPath()
      let data = null
      // í˜ì´ì§€ ë¡œë“œ ì‹œ JSON ë°ì´í„° ë¡œë”©
      window.addEventListener('DOMContentLoaded', async () => {
        const projectName = getProjectNameFromPath()
        document.title = `${projectName} í¼ë¸”ë¦¬ì‹± íŒŒì¼ë¦¬ìŠ¤íŠ¸`
        try {
          const res = await fetch(
            `/publishing_template_api/get?project=${encodeURIComponent(projectName)}`,
          )
          const json = await res.json()

          if (!json.success) {
            alert(json.message || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.')
            return
          }

          const { data, colHeaders, colWidths, mergeCells } = json.data || {}

          hot.loadData(data || [])

          const columns = Array.isArray(colWidths) ? colWidths.map((w) => ({ width: w })) : []

          hot.updateSettings({
            colHeaders: colHeaders || [],
            mergeCells: mergeCells || [],
            manualColumnResize: true,
            colWidths: colWidths || [],
          })

          console.log('ë°ì´í„°:', data)
          console.log('í—¤ë”:', colHeaders)
          console.log('ì»¬ëŸ¼:', columns)
          console.log('ë¨¸ì§€:', mergeCells)
        } catch (err) {
          console.error(err)
          alert('ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
        }
      })

      const container = document.getElementById('hot')

      const buttonRenderer = (instance, td, row, col, prop, value, cellProperties) => {
        td.innerHTML = `<button class="action-btn" data-row="${row}">ë³´ê¸°</button>`
        td.classList.add('htCenter', 'htMiddle')
        return td
      }

      const hot = new Handsontable(container, {
        data: [],
        colHeaders: ['No', '1Depth', 'íŒŒì¼ì´ë¦„', 'ë³´ê¸°', 'ë¹„ê³ '],
        width: '100%',
        height: 'auto',
        columnHeaders: true,
        mergeCells: true,
        contextMenu: true,
        manualRowResize: true,
        manualColumnResize: true,
        stretchH: 'all',
        licenseKey: 'non-commercial-and-evaluation',
      })

      hot.updateSettings({
        cells: function (row, col) {
          const cellProperties = {}
          const totalCols = this.instance.countCols()

          // í•­ìƒ ë§ˆì§€ë§‰ ì—´ ë°”ë¡œ ì• ì»¬ëŸ¼ì´ 'ë³´ê¸°' ì—´ì´ë¼ê³  ê°€ì •
          const viewButtonColIndex = totalCols - 2

          if (col === viewButtonColIndex) {
            cellProperties.renderer = buttonRenderer
            cellProperties.readOnly = true
          }

          return cellProperties
        },
      })

      container.addEventListener('click', (e) => {
        if (e.target.classList.contains('action-btn')) {
          const row = parseInt(e.target.dataset.row, 10)

          // ë™ì ìœ¼ë¡œ "íŒŒì¼ì´ë¦„" ì—´ì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
          const colHeaders = hot.getColHeader()
          const fileNameColIndex = colHeaders.findIndex((header) => header === 'íŒŒì¼ì´ë¦„')

          if (fileNameColIndex === -1) {
            alert('"íŒŒì¼ì´ë¦„" ì—´ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')
            return
          }

          const fileName = hot.getDataAtCell(row, fileNameColIndex)
          if (fileName) {
            window.open(`./${fileName}`, '_blank')
          } else {
            alert('íŒŒì¼ ì´ë¦„ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.')
          }
        }
      })

      function addCol() {
        const newHeader = prompt('ì¶”ê°€í•  ì—´ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:')
        if (!newHeader) return

        const positionInput = prompt(`ì—´ì„ ì¶”ê°€í•  ìœ„ì¹˜ (0 ~ ${hot.countCols()})ì„ ì…ë ¥í•˜ì„¸ìš”:`)
        const position = parseInt(positionInput, 10)

        if (isNaN(position) || position < 0 || position > hot.countCols()) {
          alert('ìœ íš¨í•œ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.')
          return
        }

        const currentHeaders = [...hot.getColHeader()]
        // ğŸ”½ columns ì œê±° (Handsontableê°€ object ê¸°ë°˜ ë°ì´í„°ë¡œ columns ì„¤ì •ì‹œ insert_col_start ë¶ˆê°€)
        // const currentColumns = [...(hot.getSettings().columns || [])]

        hot.alter('insert_col_start', position)

        for (let r = 0; r < hot.countRows(); r++) {
          hot.setDataAtCell(r, position, '')
        }

        currentHeaders.splice(position, 0, newHeader)

        hot.updateSettings({
          colHeaders: currentHeaders,
        })

        // ğŸ”½ ê¸°ë³¸ í­ë„ ì§ì ‘ ì„¤ì •
        hot.setColWidth(position, 100)
      }

      function saveData() {
        const colWidths = []
        for (let i = 0; i < hot.countCols(); i++) {
          // ğŸ”½ ìˆ«ìë§Œ ì €ì¥
          colWidths.push(hot.getColWidth(i))
        }

        const payload = {
          filelist: {
            data: hot.getData(),
            colHeaders: hot.getColHeader(),
            mergeCells: hot.getSettings().mergeCells || [],
            colWidths, // âœ… ìˆ«ì ë°°ì—´
          },
        }

        fetch(`/publishing_template_api/save?project=${encodeURIComponent(projectName)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        })
          .then((res) => res.json())
          .then((res) => alert(res.message || 'ì €ì¥ ì™„ë£Œ'))
          .catch((err) => {
            alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ')
            console.error(err)
          })
      }
    </script>
  </body>
</html>
